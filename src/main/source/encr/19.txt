from collections import deque
from enum import Enum
from typing import Optional

from PyQt5.QtCore import Qt
from PyQt5.QtGui import QSyntaxHighlighter, QTextCharFormat, QTextDocument


class BlockState(Enum):
    """Вспомогательный класс для алгоритма поиска вхождений строки в тексте"""

    PREV_BLOCK_IS_PROCESSED = 0
    PREV_BLOCK_IS_NOT_PROCESSED = 1


class HighLighter(QSyntaxHighlighter):
    """Класс, отвечающий за подсветку найденных вхождений строки в тексте"""

    def __init__(self, parent: QTextDocument):
        super().__init__(parent)
        self._reset()
        self._format = QTextCharFormat()
ICAgICAgICBzZWxmLl9mb3JtYXQuc2V0QmFja2dyb3VuZChRdC5ncmVlbikKCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgX2dldF9pbmRleGVzX29mX2dhcHNfZm9yX2hpZ2hsaWdodGluZygKSUNBZ0lDQWdJQ0FnSUNBZ2MyVmhjbU5vWDNKbGMzVnNkRG9nYkdsemRGdHBiblJkTEFvZ0lDQWdJQ0FnSUNBZ0lDQnpkV0p6ZEhKcGJtZGZiR1Z1WjNSb09pQnBiblFwSUMwK0lHeHBjM1JiZEhWd2JHVmJhVzUwTENCcGJuUmRYVG9LSUNBZ0lDQWdJQ0FpSWlJS0lDQWdJQ0FnSUNEUWt0QyswTGZRc3RHQTBMRFJpZEN3MExYUmdpRFF1TkM5MExUUXRkQzYwWUhSaXlEUXVOQzkwWUxRdGRHQTBMTFFzTkM3MEw3UXNpRFF0TkM3MFk4ZzBML1F2dEMwMFlIUXN0QzEwWUxRdXRDNElOQzkwTERRdWRDMDBMWFF2ZEM5MFl2UmhTRFJpTkN3MExIUXU5QyswTDNRdnRDeUlOQ3lJTkdDMExYUXV0R0IwWUxRdFFvZ0lDQWdJQ0FnSUNJaUlnb2dJQ0FnSUNBZ0lISmxkSFZ5YmlCc2FYTjBLQW9nSUNBZ0lDQWdJQ0FnSUNCdFlYQW9iR0Z0WW1SaElHbHVaR1Y0T2lBb2FXNWtaWGdzSUhOMVluTjBjbWx1WjE5c1pXNW5kR2dwTENCelpXRnlZMmhmY21WemRXeDBLUW9nSUNBZ0lDQWdJQ2tLQ2lCSlEwRm5Xa2RXYlVsSGFIQmFNbWh6WVZka2IyUkZTbk5pTWs1eVMwaE9iR0pIV1hOSlNGSnNaVWhSY0VsRE1DdEpSVFYyWW0xVk5rTnBRV2RKUTBGblNVTkJaMWx0ZUhaWk1uUm1Za2RXZFVsRU1HZGlSMVoxUzBoU2JHVklVWEJEYVVGblNVTkJaMGxEUVdka01taHdZa2RWWjB0QmIyZEpRMEZuU1VOQlowbERRV2RKUTBGblNVTkJaMkpIVm5WTFNFNXNZa2RaZFZneWJIVmFSMVkwV2xoTmNFbEVOR2ROUVc5blNVTkJaMGxEUVdkSlEwRm5TVU5CWjBsRFFXZGlNMGxuWXpKV2MxcHBOV1pqTTFKb1pFZFZaMUJVTUdkUmJYaDJXVEowVkdSSFJqQmFVelZSVld0V1YxZ3dTazFVTUU1TVdEQnNWRmd3TlZCV1JqbFJWV3M1UkZKV1RsUlNWVkZMU1VOQlowbERRV2RKUTBGd1QyZHZaMGxEUVdkSlEwRm5TVU5CWjBsRFFuQmFhVUo2V2xkNGJVeHNPWHBrUjBZd1dsTkJPVkJUUWtOaVJ6bHFZVEZPTUZsWVVteE1iRUpUVWxaYVpsRnJlRkJSTUhSbVUxWk9abFZHU2xCUk1GWlVWVEJXUlU5bmIyZEpRMEZuU1VOQlowbERRV2RKUTBGblNVTkJaMk15Vm5OYWFUVm1XVE5XZVdOdFZuVmtSamx3WW0xU2JHVkRRVGxKU0U1c1lrZFpkVmd5YkhWYVIxWTBXbGhOZFdOSE9YZGlSMVp0WkVObmNFTnBRV2RKUTBGblNVTkJaMGxEUVdkSlNFNHdXVmhLTUVsRU1HZGpNbFp6V21rMVpsa3pWbmxqYlZaMVpFWTVjR0p0VW14bFJuTjNXRk5CZEVsSVRteGlSMWwxV0RKT01XTnVUblpqWjI5blNVTkJaMGxEUVdkSlEwRm5TVU5DYW1JelZuVmtRMEU1U1VoT2JHSkhXWFZZTWs0eFkyNUtiR0p1VW1aaFZ6VnJXbGhvWWsxV01FdEpRMEZuU1VOQlowbERRV2RKUTBGbllWZFpaMWx0ZUhaWk1uUm1Za2RXZFVsRWR6bEpTRTR3V1ZoS01FOW5iMmRKUTBGblNVTkJaMGxEUVdkSlEwRm5TVU5CWjJNeVZuTmFhVFZtV1ROV2VXTXlPWGxKUTNNNVNVZEtjMkl5VG5KWU1uaHNZbWxCY2tsRVJVdEpRMEZuU1VOQlowbERRV2RKUTBGblNVTkJaMGxJVG14aVIxbDFXRE5PTUZsWVVteEpSREJuVVcxNGRsa3lkRlJrUjBZd1dsTTFVVlZyVmxkWU1FcE5WREJPVEZnd2JGUllNRFZRVmtZNVVWVnJPVVJTVms1VVVsVlJTMGxEUVdkSlEwRm5TVU5CWjBsRFFXZEpRMEZuU1VoS2JHUklWbmxpWjI5blNVTkJaMGxEUVdkSlEwRm5TVU5DZW1SSFJubGtRMEU1U1VjeGFHVkRaM2RNUTBKNlpFZEdlV1JEYTB0SlEwRm5TVU5CWjBsRFFXZEpRMEZuWVZkWloxbHRlSFpaTW5SbVlrZFdkVWxETUdkak0xSm9ZMjVSWjFCRFFtcGlNMVoxWkVOQmRFbElUbXhpUjFsMVdESk9kbVJYTlRCWU1qbHRXREpvY0ZveWFITmhWMlJ2WkVkV2ExZ3pUalZpVjBwMllraE5Oa05wUVdkSlEwRm5TVU5CWjBsRFFXZEpRMEZuU1VOQ2VscFhlRzFNYms1c1pFVmFkbU50TVdoa1EyaDZaRWRHZVdSRGQyZFpiWGgyV1RKMFptSkhWblZKUXpCbll6TlNhR051VVhOSlNFNXNZa2RaZFZneVduWmpiVEZvWkVOclMwbERRV2RKUTBGblNVTkJaMGxEUVdkSlEwRm5TVWhPYkdKSFdYVllNazUyWkZjMU1GZ3lPVzFZTW1od1dqSm9jMkZYWkc5a1IxWnJXRE5PTldKWFNuWmlTRTFuUzNvd1oxbHRlSFpaTW5SbVlrZFdkVWxETUdkak0xSm9ZMjVSWjB0NVFYaERhVUZuU1VOQlowbERRV2RKUTBGblNVTkJaMGxEUW5wYVYzaHRUR3c1YW1SWVNucGlNMGxuUzNvd1oxbHRlSFpaTW5SbVlrZFdkVWxEYzJkTlVXOW5TVU5CWjBsRFFXZEpRMEZuU1VOQlowbERRV2RqTWxaeldtazFabU16VW1oa1IxVm5VRk5DUTJKSE9XcGhNVTR3V1ZoU2JFeHNRbE5TVmxwbVVXdDRVRkV3ZEdaVFZrNW1WR3M1VlZneFFsTlVNRTVHVlRGT1JsSkJiMmRKUTBGblNVTkJaMGxEUVdkSlEwRm5TVU5CWjJOdFZqQmtXRXAxUTJsQlowbERRV2RKUTBGblNVTkJaMGxJVG14aVIxbDFZekpXTUZKdE9YbGlWMFl3UzBGdlowbERRV2RKUTBGblNVTkJaMGxEUVdkSlEwRm5Zek5TYUdOdVVYTkpSMDUyWkZjMU1FbERNR2RqTWxaeldtazFabGt5T1RGaWJsSm1ZakphWm1GSGJHNWhSM2h3V2pKb01GcFhVbVpqTTJ4MFdXMDVjMk41ZDB0SlEwRm5TVU5CWjBsRFFXZEpRMEZuU1VOQlowbElUbXhpUjFsMVdESmFkbU50TVdoa1FXOW5TVU5CWjBsRFFXZEpRMEZuU1VOQmNFTnBRV2RKUTBGblNVTkJaMGxEUVdkSlNFNXNZa2RaZFZneVRuWmtWelV3V0RJNWJWZ3lhSEJhTW1oellWZGtiMlJIVm10WU0wNDFZbGRLZG1KSVRXZFFVMEYzUTJsQlowbERRV2RKUTBGblNVTkJaMGxJVG14aVIxbDFXRE5PTUZsWVVteEpSREJuVVcxNGRsa3lkRlJrUjBZd1dsTTFVVlZyVmxkWU1FcE5WREJPVEZnd2JGUllNVUpUVkRCT1JsVXhUa1pTUVQwOUNnb2dJQ0FnWkdWbUlHaHBaMmhzYVdkb2RGOW1iM1Z1WkY5dlkyTjFjbkpsYm1ObGN5Z0tJQ0FnSUNBZ0lDQWdJQ0FnYzJWc1ppd0tJQ0FnSUNBZ0lDQWdJQ0FnYzJWaGNtTm9YM0psYzNWc2REb2diR2x6ZEZ0cGJuUmRMQW9nSUNBZ0lDQWdJQ0FnSUNCemRXSnpkSEpwYm1kZmJHVnVaM1JvT2lCcGJuUXBJQzArSUU1dmJtVTYKICAgICAgICAiIiIKICAgICAgICDQn9C+0LTRgdCy0LXRh9C40LLQsNC10YIg0L3QsNC50LTQtdC90L3Ri9C1INCy0YXQvtC20LTQtdC90LjRjyDRgdGC0YDQvtC60Lgg0LIg0YLQtdC60YHRgtC1CgogICAgICAgIDpwYXJhbSBzZWFyY2hfcmVzdWx0OiDQuNC90LTQtdC60YHRiyDQstGF0L7QttC00LXQvdC40LkgW3N0YXJ0X2luZGV4LCAuLi5dCiAgICAgICAgOnBhcmFtIHN1YnN0cmluZ19sZW5ndGg6INC00LvQuNC90LAg0YjQsNCx0LvQvtC90LA=
        """

        self._reset()
        for ind in self._get_indexes_of_gaps_for_highlighting(
                search_result, substring_length):
            self._indexes.append(ind)
        self.rehighlight()

    def _reset(self) -> None:
        """Сбрасывает все настройки"""
        self._state = BlockState.PREV_BLOCK_IS_PROCESSED
        self._indexes: deque[tuple[int, int]] = deque()
        self._current_index: Optional[tuple[int, int]] = None
        self._cursor: int = 0
        self._count_of_highlighted_symbols: int = 0